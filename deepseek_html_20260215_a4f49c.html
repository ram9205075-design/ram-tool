<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ram Earning Tools - Earn Money Online</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            transition: all 0.3s ease;
        }
        
        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 15px 30px -5px rgba(99, 102, 241, 0.2);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .admin-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .admin-table tr:hover {
            background: #f9fafb;
        }
        
        .copy-btn {
            padding: 4px 8px;
            background: #f3f4f6;
            border-radius: 6px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .copy-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .action-btn.approve {
            background: #10b981;
            color: white;
        }
        
        .action-btn.approve:hover {
            background: #059669;
        }
        
        .action-btn.reject {
            background: #ef4444;
            color: white;
        }
        
        .action-btn.reject:hover {
            background: #dc2626;
        }
        
        .action-btn.edit {
            background: #8b5cf6;
            color: white;
        }
        
        .action-btn.edit:hover {
            background: #7c3aed;
        }
        
        .action-btn.view {
            background: #3b82f6;
            color: white;
        }
        
        .action-btn.view:hover {
            background: #2563eb;
        }
        
        .tab-btn {
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        
        .tab-btn.active {
            color: #8b5cf6;
            border-bottom-color: #8b5cf6;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
        }

        .method-btn {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .method-btn.active {
            border-color: #8b5cf6;
            background: #f5f3ff;
            color: #8b5cf6;
        }

        .method-btn:hover {
            border-color: #8b5cf6;
        }

        .user-logout-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }

        .user-logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    Ram Earning Tools
                </h1>
                <div class="flex items-center gap-4">
                    <button onclick="showSection('home')" class="text-gray-700 hover:text-indigo-600 px-3 py-2">Home</button>
                    <button onclick="showSection('dashboard')" class="text-gray-700 hover:text-indigo-600 px-3 py-2">Dashboard</button>
                    <button id="adminBtn" onclick="showSection('admin')" class="text-gray-700 hover:text-indigo-600 px-3 py-2">
                        <i class="fas fa-user-shield text-xl"></i>
                    </button>
                    <button id="logoutBtn" onclick="logout()" class="hidden text-red-600 hover:text-red-700 px-3 py-2">
                        <i class="fas fa-sign-out-alt text-xl"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- User Logout Button (for dashboard) -->
    <div id="userLogoutBtn" class="user-logout-btn hidden" onclick="userLogout()">
        <i class="fas fa-sign-out-alt mr-2"></i>Logout from Dashboard
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="loading-spinner"></div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        
        <!-- Home Section -->
        <div id="homeSection">
            <!-- Hero -->
            <div class="text-center py-12">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Start Earning Money Today!</h1>
                <p class="text-lg text-gray-600 mb-6 max-w-2xl mx-auto">Join thousands of users who are already earning daily with Ram Earning Tools.</p>
                <button onclick="showRegisterModal()" class="gradient-btn text-white px-8 py-3 rounded-lg text-lg font-semibold">
                    <i class="fas fa-rocket mr-2"></i>Start Earning Now
                </button>
            </div>

            <!-- Registration Modal -->
            <div id="registerModal" class="hidden fixed inset-0 modal z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-md w-full p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Register</h2>
                        <button onclick="hideRegisterModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Your Name</label>
                        <input type="text" id="regName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Enter your name">
                    </div>
                    <button onclick="registerUser()" class="gradient-btn text-white w-full py-2 rounded-lg font-semibold">
                        <i class="fas fa-user-plus mr-2"></i>Register
                    </button>
                </div>
            </div>

            <!-- Success Modal -->
            <div id="successModal" class="hidden fixed inset-0 modal z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl max-w-md w-full p-6">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check-circle text-3xl text-green-500"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">Registration Successful!</h2>
                        <p class="text-gray-600 mb-4">Your account is pending approval</p>
                        <div class="bg-purple-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-purple-600 mb-1">Your User ID:</p>
                            <p id="successUserId" class="text-lg font-mono font-bold"></p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-gray-600 mb-1">Referral Link:</p>
                            <p id="successLink" class="text-sm text-blue-600 break-all mb-2"></p>
                            <button onclick="copySuccessLink()" class="text-purple-600 hover:text-purple-700">
                                <i class="fas fa-copy mr-1"></i>Copy Link
                            </button>
                        </div>
                        <button onclick="goHome()" class="gradient-btn text-white px-6 py-2 rounded-lg">
                            Continue to Home
                        </button>
                    </div>
                </div>
            </div>

            <!-- Features -->
            <div class="grid md:grid-cols-3 gap-6 my-12">
                <div class="card p-6 text-center">
                    <i class="fas fa-bolt text-3xl text-purple-600 mb-3"></i>
                    <h3 class="font-semibold mb-2">Fast Payments</h3>
                    <p class="text-gray-600">Instant withdrawals to your UPI</p>
                </div>
                <div class="card p-6 text-center">
                    <i class="fas fa-shield-alt text-3xl text-purple-600 mb-3"></i>
                    <h3 class="font-semibold mb-2">100% Secure</h3>
                    <p class="text-gray-600">Your payments are protected</p>
                </div>
                <div class="card p-6 text-center">
                    <i class="fas fa-headset text-3xl text-purple-600 mb-3"></i>
                    <h3 class="font-semibold mb-2">24/7 Support</h3>
                    <p class="text-gray-600">We're always here to help</p>
                </div>
            </div>

            <!-- Payment Proofs -->
            <div class="my-12">
                <h2 class="text-2xl font-bold text-center mb-6">Recent Payments</h2>
                <div id="proofsGrid" class="grid md:grid-cols-3 gap-6">
                    <p class="text-center text-gray-500 col-span-3">Loading proofs...</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <div class="max-w-3xl mx-auto">
                <!-- User ID Input -->
                <div id="userIdInput" class="card p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Enter Your User ID</h2>
                    <div class="flex gap-4">
                        <input type="text" id="userId" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="e.g., RETABC123">
                        <button onclick="loadDashboard()" class="gradient-btn text-white px-6 py-2 rounded-lg">
                            View Dashboard
                        </button>
                    </div>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboardContent" class="hidden space-y-6">
                    <!-- User Info -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold" id="dashName"></h2>
                            <span id="dashStatus" class="status-badge"></span>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-sm text-gray-500">User ID</p>
                                <p id="dashUserId" class="font-mono font-semibold"></p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-sm text-gray-500">Referral Link</p>
                                <div class="flex items-center gap-2">
                                    <p id="dashReferral" class="text-sm text-blue-600 truncate"></p>
                                    <button onclick="copyDashLink()" class="copy-btn">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monetag Link Section - Only visible when approved -->
                        <div id="monetagContainer" class="hidden bg-purple-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-purple-600 mb-2">Your Earning Link:</p>
                            <div class="flex items-center gap-2">
                                <a id="monetagLink" href="#" target="_blank" class="text-blue-600 hover:underline flex-1 break-all"></a>
                                <button onclick="copyMonetagLink()" class="copy-btn">
                                    <i class="fas fa-copy mr-1"></i>Copy
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded text-center">
                                <p class="text-2xl font-bold text-blue-600" id="dashViews">0</p>
                                <p class="text-sm">Total Views</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded text-center">
                                <p class="text-2xl font-bold text-green-600" id="dashEarnings">₹0</p>
                                <p class="text-sm">Total Earnings</p>
                            </div>
                        </div>
                    </div>

                    <!-- Withdrawal -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4">Request Withdrawal</h3>
                        <div class="bg-purple-50 p-4 rounded mb-4">
                            <p class="text-sm text-purple-600">Available Balance</p>
                            <p class="text-3xl font-bold text-purple-700" id="balance">₹0</p>
                            <p class="text-xs text-purple-500 mt-1" id="minAmount">Min: ₹50</p>
                        </div>
                        <div class="space-y-4">
                            <input type="number" id="withdrawAmount" class="w-full px-4 py-2 border rounded-lg" placeholder="Enter Amount">
                            
                            <!-- Payment Methods -->
                            <div>
                                <label class="block text-sm font-medium mb-2">Select Payment Method</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="setMethod('gpay')" id="methodGpay" class="method-btn">
                                        <i class="fab fa-google-pay mr-2"></i>Google Pay
                                    </button>
                                    <button onclick="setMethod('phonepe')" id="methodPhonepe" class="method-btn">
                                        <i class="fas fa-mobile-alt mr-2"></i>PhonePe
                                    </button>
                                    <button onclick="setMethod('upi')" id="methodUpi" class="method-btn active">
                                        <i class="fas fa-university mr-2"></i>UPI
                                    </button>
                                </div>
                            </div>

                            <!-- UPI ID Input -->
                            <div>
                                <label class="block text-sm font-medium mb-2">UPI ID</label>
                                <div class="flex gap-2">
                                    <input type="text" id="upiId" class="flex-1 px-4 py-2 border rounded-lg" placeholder="e.g., name@okhdfcbank">
                                    <button onclick="validateUPI()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Example: username@okhdfcbank, username@ybl, username@apl</p>
                            </div>

                            <!-- UPI QR Option (for Google Pay/PhonePe) -->
                            <div id="qrOption" class="hidden bg-blue-50 p-3 rounded-lg">
                                <p class="text-sm text-blue-600 mb-2">Quick Option:</p>
                                <button onclick="showQRScanner()" class="text-blue-600 hover:text-blue-700">
                                    <i class="fas fa-qrcode mr-2"></i>Scan QR Code
                                </button>
                            </div>

                            <button onclick="submitWithdrawal()" id="withdrawBtn" class="gradient-btn text-white w-full py-3 rounded-lg font-semibold">
                                <i class="fas fa-money-bill-wave mr-2"></i>Request Withdrawal
                            </button>
                        </div>
                    </div>

                    <!-- Withdrawal History -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4">Withdrawal History</h3>
                        <div id="historyList" class="space-y-3">
                            <p class="text-center text-gray-500">No history yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="hidden">
            <div class="max-w-7xl mx-auto">
                <!-- Login Form -->
                <div id="adminLogin" class="card p-8 max-w-md mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="adminEmail" class="w-full px-4 py-3 border rounded-lg" value="admin@ram.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Password</label>
                            <input type="password" id="adminPassword" class="w-full px-4 py-3 border rounded-lg">
                        </div>
                        <button onclick="adminLogin()" class="gradient-btn text-white w-full py-3 rounded-lg font-semibold">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </button>
                    </div>
                </div>

                <!-- Admin Dashboard -->
                <div id="adminDashboard" class="hidden">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                        <div class="stat-card">
                            <p class="text-3xl font-bold" id="totalUsers">0</p>
                            <p class="text-sm opacity-90">Total Users</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)">
                            <p class="text-3xl font-bold" id="pendingUsers">0</p>
                            <p class="text-sm opacity-90">Pending</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%)">
                            <p class="text-3xl font-bold" id="approvedUsers">0</p>
                            <p class="text-sm opacity-90">Approved</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)">
                            <p class="text-3xl font-bold" id="totalWithdrawals">0</p>
                            <p class="text-sm opacity-90">Total Withdrawals</p>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%)">
                            <p class="text-3xl font-bold" id="pendingWithdrawals">0</p>
                            <p class="text-sm opacity-90">Pending Withdrawals</p>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 mb-6 border-b">
                        <button onclick="switchTab('pending')" class="tab-btn active" id="pendingTabBtn">
                            <i class="fas fa-clock mr-2"></i>Pending Users
                        </button>
                        <button onclick="switchTab('approved')" class="tab-btn" id="approvedTabBtn">
                            <i class="fas fa-check-circle mr-2"></i>Approved Users
                        </button>
                        <button onclick="switchTab('withdrawals')" class="tab-btn" id="withdrawalsTabBtn">
                            <i class="fas fa-money-bill-wave mr-2"></i>Withdrawals
                        </button>
                    </div>

                    <!-- Pending Users Table -->
                    <div id="pendingUsersTable" class="card p-6">
                        <h3 class="text-xl font-bold mb-4">Pending Approval</h3>
                        <div class="overflow-x-auto">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>User ID</th>
                                        <th>Registered</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingUsersList">
                                    <tr>
                                        <td colspan="4" class="text-center py-8 text-gray-500">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Approved Users Table -->
                    <div id="approvedUsersTable" class="hidden card p-6">
                        <h3 class="text-xl font-bold mb-4">Approved Users</h3>
                        <div class="overflow-x-auto">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>User ID</th>
                                        <th>Views</th>
                                        <th>Earnings</th>
                                        <th>Monetag Link</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedUsersList">
                                    <tr>
                                        <td colspan="7" class="text-center py-8 text-gray-500">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Withdrawals Table -->
                    <div id="withdrawalsTable" class="hidden card p-6">
                        <h3 class="text-xl font-bold mb-4">Withdrawal Requests</h3>
                        <div class="overflow-x-auto">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>UPI ID</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Proof</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawalsList">
                                    <tr>
                                        <td colspan="8" class="text-center py-8 text-gray-500">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, updateDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCzCHZhz-1-enmDkuuvlfXkMD_-2gsHirM",
            authDomain: "rewardbee-140fe.firebaseapp.com",
            projectId: "rewardbee-140fe",
            storageBucket: "rewardbee-140fe.firebasestorage.app",
            messagingSenderId: "247840776508",
            appId: "1:247840776508:web:1e15bd4c78c96df156fe39"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make available globally
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.firebaseFunctions = {
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            doc,
            setDoc,
            addDoc,
            getDoc,
            getDocs,
            updateDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            serverTimestamp,
            ref,
            uploadBytes,
            getDownloadURL
        };

        console.log("Firebase ready");

        // Auth State
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === 'admin@ram.com') {
                document.getElementById('adminBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                if (!document.getElementById('adminSection').classList.contains('hidden')) {
                    document.getElementById('adminLogin').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    loadAdminData();
                }
            } else {
                document.getElementById('adminBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('adminLogin').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
            }
        });
    </script>

    <!-- Main Script -->
    <script>
        // State
        let currentUser = null;
        let currentMethod = 'upi';
        let usersListener = null;
        let withdrawalsListener = null;
        let historyListener = null;

        // Helper Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        function showToast(title, msg, icon) {
            Swal.fire({ title, text: msg, icon, timer: 2000, showConfirmButton: false });
        }
        function generateId() {
            return 'RET' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        function maskName(name) {
            if (!name) return '';
            if (name.length <= 2) return name[0] + '*';
            return name[0] + '*'.repeat(name.length - 2) + name[name.length - 1];
        }
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('en-IN');
            } catch {
                return 'N/A';
            }
        }

        // UPI Validation
        function validateUPI() {
            const upi = document.getElementById('upiId').value.trim();
            const upiRegex = /^[a-zA-Z0-9.\-_]{2,}@[a-zA-Z]{2,}$/;
            
            if (!upi) {
                showToast('Error', 'Enter UPI ID', 'error');
                return false;
            }
            
            if (!upiRegex.test(upi)) {
                showToast('Error', 'Invalid UPI format', 'error');
                return false;
            }
            
            showToast('Success', 'Valid UPI ID', 'success');
            return true;
        }

        function showQRScanner() {
            Swal.fire({
                title: 'Scan QR Code',
                text: 'Please use your UPI app to scan QR code',
                icon: 'info',
                confirmButtonColor: '#8b5cf6'
            });
        }

        // Navigation
        function showSection(section) {
            document.getElementById('homeSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            if (section === 'home') {
                document.getElementById('userLogoutBtn').classList.add('hidden');
                loadProofs();
            } else if (section === 'dashboard') {
                document.getElementById('userLogoutBtn').classList.remove('hidden');
            } else {
                document.getElementById('userLogoutBtn').classList.add('hidden');
            }
        }

        // User Logout
        function userLogout() {
            currentUser = null;
            currentUserId = null;
            document.getElementById('userIdInput').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('userId').value = '';
            document.getElementById('userLogoutBtn').classList.add('hidden');
            showSection('home');
            showToast('Success', 'Logged out from dashboard', 'success');
        }

        // Registration
        function showRegisterModal() {
            document.getElementById('registerModal').classList.remove('hidden');
        }
        function hideRegisterModal() {
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('regName').value = '';
        }
        function goHome() {
            document.getElementById('successModal').classList.add('hidden');
            showSection('home');
        }
        function copySuccessLink() {
            const link = document.getElementById('successLink').textContent;
            navigator.clipboard.writeText(link);
            showToast('Copied!', 'Link copied to clipboard', 'success');
        }
        function copyMonetagLink() {
            const link = document.getElementById('monetagLink').href;
            navigator.clipboard.writeText(link);
            showToast('Copied!', 'Monetag link copied', 'success');
        }

        async function registerUser() {
            const name = document.getElementById('regName').value.trim();
            if (!name) {
                showToast('Error', 'Enter your name', 'error');
                return;
            }

            showLoading();
            try {
                const userId = generateId();
                const referralLink = window.location.origin + '/?ref=' + userId;
                
                await window.firebaseFunctions.setDoc(
                    window.firebaseFunctions.doc(db, 'users', userId),
                    {
                        name,
                        userId,
                        referralLink,
                        status: 'pending',
                        monetagLink: '',
                        totalViews: 0,
                        totalEarnings: 0,
                        isFirstWithdrawal: true,
                        createdAt: window.firebaseFunctions.serverTimestamp()
                    }
                );

                hideRegisterModal();
                document.getElementById('successUserId').textContent = userId;
                document.getElementById('successLink').textContent = referralLink;
                document.getElementById('successModal').classList.remove('hidden');
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Payment Proofs
        async function loadProofs() {
            try {
                const q = window.firebaseFunctions.query(
                    window.firebaseFunctions.collection(db, 'withdrawals'),
                    window.firebaseFunctions.where('status', '==', 'approved'),
                    window.firebaseFunctions.orderBy('date', 'desc'),
                    window.firebaseFunctions.limit(6)
                );
                const snap = await window.firebaseFunctions.getDocs(q);
                const grid = document.getElementById('proofsGrid');
                
                if (snap.empty) {
                    grid.innerHTML = '<p class="text-center text-gray-500 col-span-3">No proofs yet</p>';
                    return;
                }

                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                        <div class="card overflow-hidden">
                            <img src="${d.paymentProofImage}" class="h-40 w-full object-cover cursor-pointer" onclick="window.open('${d.paymentProofImage}')">
                            <div class="p-4">
                                <p class="font-semibold">${maskName(d.userName)}</p>
                                <p class="text-green-600 font-bold">₹${d.amount}</p>
                                <p class="text-sm text-gray-500">${formatDate(d.date)}</p>
                            </div>
                        </div>
                    `;
                });
                grid.innerHTML = html;
            } catch (err) {
                console.error(err);
            }
        }

        // Dashboard
        async function loadDashboard() {
            const uid = document.getElementById('userId').value.trim();
            if (!uid) {
                showToast('Error', 'Enter User ID', 'error');
                return;
            }

            showLoading();
            try {
                const docRef = window.firebaseFunctions.doc(db, 'users', uid);
                const docSnap = await window.firebaseFunctions.getDoc(docRef);
                
                if (!docSnap.exists()) {
                    showToast('Error', 'User not found', 'error');
                    hideLoading();
                    return;
                }

                const data = docSnap.data();
                currentUser = { id: docSnap.id, ...data };

                // Update UI
                document.getElementById('dashName').textContent = data.name;
                document.getElementById('dashUserId').textContent = data.userId;
                document.getElementById('dashReferral').textContent = data.referralLink;
                document.getElementById('dashViews').textContent = data.totalViews || 0;
                document.getElementById('dashEarnings').textContent = '₹' + (data.totalEarnings || 0);
                document.getElementById('balance').textContent = '₹' + (data.totalEarnings || 0);
                
                const statusEl = document.getElementById('dashStatus');
                statusEl.textContent = data.status;
                statusEl.className = 'status-badge status-' + data.status;

                const minAmt = data.isFirstWithdrawal ? 50 : 200;
                document.getElementById('minAmount').textContent = `Min: ₹${minAmt}`;

                // Show Monetag link only if approved
                if (data.status === 'approved' && data.monetagLink) {
                    document.getElementById('monetagContainer').classList.remove('hidden');
                    document.getElementById('monetagLink').textContent = data.monetagLink;
                    document.getElementById('monetagLink').href = data.monetagLink;
                } else {
                    document.getElementById('monetagContainer').classList.add('hidden');
                }

                const btn = document.getElementById('withdrawBtn');
                if (data.totalEarnings < minAmt || data.status !== 'approved') {
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }

                // Load history
                loadHistory(uid);

                document.getElementById('userIdInput').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('userLogoutBtn').classList.remove('hidden');
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function loadHistory(uid) {
            if (historyListener) historyListener();
            
            const q = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'withdrawals'),
                window.firebaseFunctions.where('userId', '==', uid),
                window.firebaseFunctions.orderBy('date', 'desc')
            );

            historyListener = window.firebaseFunctions.onSnapshot(q, (snap) => {
                const list = document.getElementById('historyList');
                if (snap.empty) {
                    list.innerHTML = '<p class="text-center text-gray-500">No history yet</p>';
                    return;
                }

                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                        <div class="bg-gray-50 p-3 rounded flex justify-between items-center">
                            <div>
                                <p class="font-semibold">₹${d.amount}</p>
                                <p class="text-xs text-gray-500">${d.method} • ${d.upiId} • ${formatDate(d.date)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="status-badge status-${d.status}">${d.status}</span>
                                ${d.paymentProofImage ? `
                                    <button onclick="window.open('${d.paymentProofImage}')" class="text-blue-600 hover:text-blue-700">
                                        <i class="fas fa-image"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            });
        }

        function setMethod(method) {
            currentMethod = method;
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`method${method.charAt(0).toUpperCase() + method.slice(1)}`).classList.add('active');
            
            // Show QR option for Google Pay and PhonePe
            if (method === 'gpay' || method === 'phonepe') {
                document.getElementById('qrOption').classList.remove('hidden');
            } else {
                document.getElementById('qrOption').classList.add('hidden');
            }
        }

        async function submitWithdrawal() {
            if (!currentUser) return;
            
            const amt = parseInt(document.getElementById('withdrawAmount').value);
            const upi = document.getElementById('upiId').value.trim();
            const min = currentUser.isFirstWithdrawal ? 50 : 200;

            if (!amt || amt < min) {
                showToast('Error', `Minimum ₹${min}`, 'error');
                return;
            }
            if (amt > currentUser.totalEarnings) {
                showToast('Error', 'Insufficient balance', 'error');
                return;
            }
            if (!upi) {
                showToast('Error', 'Enter UPI ID', 'error');
                return;
            }

            // Validate UPI format
            const upiRegex = /^[a-zA-Z0-9.\-_]{2,}@[a-zA-Z]{2,}$/;
            if (!upiRegex.test(upi)) {
                showToast('Error', 'Invalid UPI format', 'error');
                return;
            }

            showLoading();
            try {
                await window.firebaseFunctions.addDoc(
                    window.firebaseFunctions.collection(db, 'withdrawals'),
                    {
                        userId: currentUser.userId,
                        userName: currentUser.name,
                        amount: amt,
                        method: currentMethod,
                        upiId: upi,
                        status: 'pending',
                        paymentProofImage: '',
                        date: window.firebaseFunctions.serverTimestamp()
                    }
                );

                document.getElementById('withdrawAmount').value = '';
                document.getElementById('upiId').value = '';
                showToast('Success', 'Withdrawal request submitted!', 'success');
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function copyDashLink() {
            navigator.clipboard.writeText(currentUser.referralLink);
            showToast('Copied!', 'Link copied', 'success');
        }

        // Admin
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPassword').value;

            showLoading();
            try {
                await window.firebaseFunctions.signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                showToast('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            await window.firebaseFunctions.signOut(auth);
            if (usersListener) usersListener();
            if (withdrawalsListener) withdrawalsListener();
            if (historyListener) historyListener();
            showSection('home');
        }

        function switchTab(tab) {
            document.getElementById('pendingUsersTable').classList.add('hidden');
            document.getElementById('approvedUsersTable').classList.add('hidden');
            document.getElementById('withdrawalsTable').classList.add('hidden');
            
            document.getElementById('pendingTabBtn').classList.remove('active');
            document.getElementById('approvedTabBtn').classList.remove('active');
            document.getElementById('withdrawalsTabBtn').classList.remove('active');
            
            if (tab === 'pending') {
                document.getElementById('pendingUsersTable').classList.remove('hidden');
                document.getElementById('pendingTabBtn').classList.add('active');
            } else if (tab === 'approved') {
                document.getElementById('approvedUsersTable').classList.remove('hidden');
                document.getElementById('approvedTabBtn').classList.add('active');
            } else {
                document.getElementById('withdrawalsTable').classList.remove('hidden');
                document.getElementById('withdrawalsTabBtn').classList.add('active');
            }
        }

        function loadAdminData() {
            const q = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'users'),
                window.firebaseFunctions.orderBy('createdAt', 'desc')
            );

            if (usersListener) usersListener();
            usersListener = window.firebaseFunctions.onSnapshot(q, (snap) => {
                let pendingHtml = '';
                let approvedHtml = '';
                let total = 0;
                let pending = 0;
                let approved = 0;
                
                snap.forEach(doc => {
                    const u = doc.data();
                    total++;
                    
                    if (u.status === 'pending') {
                        pending++;
                        pendingHtml += `
                            <tr>
                                <td class="font-medium">${u.name}</td>
                                <td><span class="font-mono text-sm">${u.userId}</span></td>
                                <td>${formatDate(u.createdAt)}</td>
                                <td>
                                    <div class="flex gap-2">
                                        <button onclick="updateUserStatus('${u.userId}', 'approved')" class="action-btn approve">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                        <button onclick="updateUserStatus('${u.userId}', 'rejected')" class="action-btn reject">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else if (u.status === 'approved') {
                        approved++;
                        approvedHtml += `
                            <tr>
                                <td class="font-medium">${u.name}</td>
                                <td><span class="font-mono text-sm">${u.userId}</span></td>
                                <td>${u.totalViews || 0}</td>
                                <td>₹${u.totalEarnings || 0}</td>
                                <td>
                                    ${u.monetagLink ? `
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-blue-600 truncate max-w-[150px]">${u.monetagLink}</span>
                                            <button onclick="copyText('${u.monetagLink}')" class="copy-btn">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    ` : '<span class="text-gray-400">Not set</span>'}
                                </td>
                                <td><span class="status-badge status-approved">Approved</span></td>
                                <td>
                                    <button onclick="editUser('${u.userId}', '${u.monetagLink || ''}', ${u.totalViews || 0}, ${u.totalEarnings || 0})" class="action-btn edit">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                });

                document.getElementById('pendingUsersList').innerHTML = pendingHtml || '<tr><td colspan="4" class="text-center py-8">No pending users</td></tr>';
                document.getElementById('approvedUsersList').innerHTML = approvedHtml || '<tr><td colspan="7" class="text-center py-8">No approved users</td></tr>';
                
                document.getElementById('totalUsers').textContent = total;
                document.getElementById('pendingUsers').textContent = pending;
                document.getElementById('approvedUsers').textContent = approved;
            });

            // Load withdrawals
            const wq = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(db, 'withdrawals'),
                window.firebaseFunctions.orderBy('date', 'desc')
            );

            if (withdrawalsListener) withdrawalsListener();
            withdrawalsListener = window.firebaseFunctions.onSnapshot(wq, (snap) => {
                let html = '';
                let total = 0;
                let pending = 0;
                
                snap.forEach(doc => {
                    const w = doc.data();
                    total++;
                    if (w.status === 'pending') pending++;
                    
                    html += `
                        <tr>
                            <td class="font-medium">${w.userName}</td>
                            <td class="font-bold">₹${w.amount}</td>
                            <td>${w.method}</td>
                            <td><span class="font-mono text-sm">${w.upiId}</span></td>
                            <td>${formatDate(w.date)}</td>
                            <td><span class="status-badge status-${w.status}">${w.status}</span></td>
                            <td>
                                ${w.paymentProofImage ? `
                                    <button onclick="window.open('${w.paymentProofImage}')" class="action-btn view">
                                        <i class="fas fa-image"></i> View
                                    </button>
                                ` : '<span class="text-gray-400">No proof</span>'}
                            </td>
                            <td>
                                <div class="flex gap-2">
                                    ${w.status === 'pending' ? `
                                        <button onclick="approveWithdrawal('${doc.id}', '${w.userId}')" class="action-btn approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button onclick="rejectWithdrawal('${doc.id}')" class="action-btn reject">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('withdrawalsList').innerHTML = html || '<tr><td colspan="8" class="text-center py-8">No withdrawals found</td></tr>';
                document.getElementById('totalWithdrawals').textContent = total;
                document.getElementById('pendingWithdrawals').textContent = pending;
            });
        }

        function copyText(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied!', 'Text copied to clipboard', 'success');
        }

        async function updateUserStatus(uid, status) {
            await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'users', uid), { status });
            showToast('Success', `User ${status}`, 'success');
        }

        function editUser(uid, link, views, earnings) {
            Swal.fire({
                title: 'Edit User',
                html: `
                    <div class="space-y-3">
                        <input id="monetag" class="w-full p-2 border rounded" value="${link}" placeholder="Monetag Link">
                        <input id="views" type="number" class="w-full p-2 border rounded" value="${views}" placeholder="Total Views">
                        <input id="earnings" type="number" class="w-full p-2 border rounded" value="${earnings}" placeholder="Total Earnings">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Update',
                confirmButtonColor: '#8b5cf6',
                preConfirm: () => ({
                    monetagLink: document.getElementById('monetag').value,
                    totalViews: parseInt(document.getElementById('views').value) || 0,
                    totalEarnings: parseInt(document.getElementById('earnings').value) || 0
                })
            }).then(async (r) => {
                if (r.isConfirmed) {
                    await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'users', uid), r.value);
                    showToast('Success', 'User updated', 'success');
                }
            });
        }

        async function approveWithdrawal(wid, uid) {
            const { value: file } = await Swal.fire({
                title: 'Upload Payment Proof',
                input: 'file',
                inputAttributes: { accept: 'image/*' },
                confirmButtonColor: '#8b5cf6'
            });

            if (file) {
                showLoading();
                try {
                    const storageRef = window.firebaseFunctions.ref(storage, `proofs/${wid}_${Date.now()}`);
                    await window.firebaseFunctions.uploadBytes(storageRef, file);
                    const url = await window.firebaseFunctions.getDownloadURL(storageRef);

                    await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'withdrawals', wid), {
                        status: 'approved',
                        paymentProofImage: url
                    });

                    const user = await window.firebaseFunctions.getDoc(window.firebaseFunctions.doc(db, 'users', uid));
                    if (user.exists() && user.data().isFirstWithdrawal) {
                        await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'users', uid), {
                            isFirstWithdrawal: false
                        });
                    }

                    showToast('Success', 'Withdrawal approved', 'success');
                } catch (err) {
                    showToast('Error', err.message, 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        async function rejectWithdrawal(wid) {
            await window.firebaseFunctions.updateDoc(window.firebaseFunctions.doc(db, 'withdrawals', wid), { status: 'rejected' });
            showToast('Success', 'Withdrawal rejected', 'success');
        }

        // Expose functions
        window.showSection = showSection;
        window.showRegisterModal = showRegisterModal;
        window.hideRegisterModal = hideRegisterModal;
        window.registerUser = registerUser;
        window.goHome = goHome;
        window.copySuccessLink = copySuccessLink;
        window.copyMonetagLink = copyMonetagLink;
        window.loadDashboard = loadDashboard;
        window.setMethod = setMethod;
        window.submitWithdrawal = submitWithdrawal;
        window.copyDashLink = copyDashLink;
        window.validateUPI = validateUPI;
        window.showQRScanner = showQRScanner;
        window.adminLogin = adminLogin;
        window.logout = logout;
        window.userLogout = userLogout;
        window.switchTab = switchTab;
        window.updateUserStatus = updateUserStatus;
        window.editUser = editUser;
        window.approveWithdrawal = approveWithdrawal;
        window.rejectWithdrawal = rejectWithdrawal;
        window.copyText = copyText;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProofs();
            const ref = new URLSearchParams(location.search).get('ref');
            if (ref) {
                document.getElementById('userId').value = ref;
                setTimeout(() => {
                    showSection('dashboard');
                    loadDashboard();
                }, 500);
            }
        });
    </script>
</body>
</html>
